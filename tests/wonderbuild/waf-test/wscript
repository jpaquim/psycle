#! /usr/bin/env waf

APPNAME = 'waf-test'
VERSION = '0.0.1'

srcdir = '.'
blddir = '++build'

def init():
	pass

def set_options(opt):
	opt.tool_options('compiler_cxx')

def configure(conf):
	conf.check_tool('compiler_cxx')

def _program(bld, target, types, sources, includes, uselib_local = None):
	if 'static' in types:
		st = bld.new_task_gen('cxx', 'program')
		st.target = target + '-static'
		st.source = sources
		st.includes = includes
		if uselib_local: st.uselib_local = [u + '-static' for u in uselib_local]
	if 'shared' in types:
		sh = bld.new_task_gen('cxx', 'program')
		sh.target = target + '-shared'
		sh.source = sources
		sh.includes = includes
		sh.rpath = '\\$ORIGIN/../lib'
		if uselib_local: sh.uselib_local = [u + '-shared' for u in uselib_local]

def _lib(bld, target, types, sources, includes, headers, uselib_local = None):
	if 'static' in types:
		st = bld.new_task_gen('cxx', 'staticlib')
		st.name = target + '-static'
		st.target = target
		st.includes = includes
		st.source = sources
		if uselib_local: p.uselib_local = [u + '-static' for u in uselib_local]
	if 'shared' in types:
		sh = bld.new_task_gen('cxx', 'shlib')
		sh.name = target + '-shared'
		sh.target = target
		sh.source = sources
		sh.includes = includes
		sh.rpath = '\\$ORIGIN/../lib'
		if uselib_local: p.uselib_local = [u + '-shared' for u in uselib_local]
	_headers(bld, includes, headers)

def _headers(bld, includes, headers):
	global APPNAME, VERSION
	for i in includes:
		for h in headers:
			if h.startswith(i):
				bld.install_as('${PREFIX}/include/' + APPNAME + '-' + VERSION + '/' + h[(len(i)):], h)

def build(bld):
	#bld.add_subdirs('../diversalis')
	_lib(bld, 'foo', ['static', 'shared'], ['src/foo/foo.cpp'], ['src'], ['src/foo/foo.hpp'])
	_program(bld, 'main', ['static', 'shared'], ['src/main/main.cpp'], ['src'], ['foo'])
	_headers(bld, ['src'], ['src/bar/bar.hpp'])

def shutdown():
	pass
