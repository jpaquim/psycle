//////////////////////////////////////////////////////////////////////
//
//	Osc.h
//
//	druttis@darkface.pp.se
//
//////////////////////////////////////////////////////////////////////
#pragma once
#include "Inertia.h"
#include "Waveform.h"
//////////////////////////////////////////////////////////////////////
//
//	Amp table
//
//////////////////////////////////////////////////////////////////////
extern float	*pamptable;
//////////////////////////////////////////////////////////////////////
//
//	Osc class
//
//////////////////////////////////////////////////////////////////////
class Osc
{
private:
	Waveform	m_wave;
	float		m_phase;
	Inertia		m_incr;
public:
	Osc();
	~Osc();
	//////////////////////////////////////////////////////////////////
	//
	//	SetFreq
	//
	//////////////////////////////////////////////////////////////////
	__forceinline void SetFreq(float freq)
	{
		m_incr.SetTarget(m_wave.Get()->freq2incr);
	}
	__forceinline void SetNote(float note)
	{
		SetFreq(440.0f * (float) pow(2.0, ((double) note - 69.0) / 12.0));
	}
	__forceinline void SlideFrom(Inertia *pincr)
	{
		m_incr.SetTarget(pincr->GetValue());
		m_incr.Reset();
	}
	__forceinline void SetLength(int length)
	{
		m_incr.SetLength(length);
	}
	__forceinline float GetValue()
	{
		return m_incr.GetValue();
	}
	//////////////////////////////////////////////////////////////////
	//
	//	Stop
	//
	//////////////////////////////////////////////////////////////////
	__forceinline void Stop()
	{
		m_incr.Stop();
	}
	//////////////////////////////////////////////////////////////////
	//
	//	Reset
	//
	//////////////////////////////////////////////////////////////////
	__forceinline void Reset()
	{
		m_incr.Reset();
	}
	//////////////////////////////////////////////////////////////////
	//
	//	Clip
	//
	//////////////////////////////////////////////////////////////////
	__forceinline int Clip(int nsamples)
	{
		return m_incr.Clip(nsamples);
	}
	//////////////////////////////////////////////////////////////////
	//
	//	Next
	//
	//////////////////////////////////////////////////////////////////
	__forceinline float Next(float fm, float pm)
	{
		WAVEFORM *pwave = m_wave.Get();
		float amp = pamptable[pwave->preverse[f2i(m_incr.GetValue() * pwave->incr2freq) & 0xffff]];
		pm *= amp;
		int paridx = pwave->preverse[f2i((m_incr.GetValue() + pm) * pwave->incr2freq) & 0xffff];
		float out = m_wave.GetSample(m_phase + pm, paridx);
		m_phase += m_incr.Next() * fastpow2(fm);
		return out;
	}
};
