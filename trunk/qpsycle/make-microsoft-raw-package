#! /usr/bin/env bash

set -x &&

function main {
	cd "$(dirname $0)" &&
	rm -Rf ../*/++build && # We can't trust qmake's makefiles (unreliable when config is changed, etc), so we clean everything first.
	qmake -recursive CONFIG-=debug CONFIG-=debug_and_release &&
	mingw32-make &&
	(cd ../psycle-plugins && scons) &&
	local install_dir=++install &&
	rm -Rf $install_dir &&
	mkdir -p $install_dir/bin &&
	cp -f \
		$(find {.,../psycle-{core,audiodrivers}}/++build -iname \*.dll -or -iname \*.exe) \
		../psycle-plugins/++wonderbuild/staged-install/usr/local/bin/*.dll \
		$install_dir/bin &&
	local tar_name=qpsycle &&
	../build-systems/microsoft-dll-collector $install_dir $tar_name &&
	mkdir $install_dir/$tar_name/presets &&
	cp -Rf \
		../psycle-plugins/presets/*.prs \
		$install_dir/$tar_name/presets/ &&
	echo subversion revision "$(svnversion)" > $install_dir/$tar_name/version.text &&
	tar cvjf $install_dir/$tar_name.tar.bz2 --directory=$install_dir $tar_name &&
	ls -lh $install_dir/$tar_name.tar.bz2 &&
	#(cd $install_dir && 7za a -ms=on -mx=9 -m0=BCJ2 -m1=LZMA -m2=LZMA -m3=LZMA -mb0:1 -mb0s1:2 -mb0s2:3 $tar_name.7z $tar_name) &&
	#ls -lh $install_dir/$tar_name.7z &&
	true
} &&

main "$@"
