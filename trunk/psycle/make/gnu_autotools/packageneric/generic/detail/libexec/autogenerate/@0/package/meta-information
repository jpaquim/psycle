#! /bin/bash

##############################################################################
#
# This source is free software ; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation ; either version 2, or (at your option) any later version.
# Copyright (C) 1999-2005 Psycledelics http://psycle.pastnotecut.org : Johan Boule
#
# autogenerator plugin
# \meta generic
# \meta standard gnu
#
##############################################################################

set -eu &&

function main
{
	mkdir --parents $PACKAGENERIC__OUTPUT/$PACKAGENERIC__SUBPATH &&
	cd              $PACKAGENERIC__OUTPUT/$PACKAGENERIC__SUBPATH &&
	local meta=../../../$PACKAGENERIC__SUBPATH &&
	if test ! -e $meta
	then
		echo $(basename $PACKAGENERIC__SUBPATH): missing $meta &&
		false
		return
	fi &&
	ln --symbolic --force $meta/* . &&
	if test ! -e $PACKAGENERIC__ROOT/debian/changelog
	then
		for name in name version archive
		do
			if test ! -e $name
			then
				echo $(basename $PACKAGENERIC__SUBPATH): missing meta $name &&
				false
				return
			fi
		done &&
		local version=$(< version)
	else
		local head=$(head --lines 1 $PACKAGENERIC__ROOT/debian/changelog) &&
		
		local    name=$(echo $head | cut --delimiter ' ' --fields 1) &&
		echo '"'$name'"' > name &&
		
		local version=$(echo $head | cut --delimiter ' ' --fields 2 | sed 's/[^0-9\.]//g') &&
		echo '"'$version'"' > version &&
		
		local archive=$(echo $head | cut --delimiter ' ' --fields 3 | sed 's/\;$//') &&
		echo '"'$archive'"' > archive
	fi &&

	echoing '' &&
	echoing '===========================================================' &&
	echoing "packageneric $($PACKAGENERIC__ROOT/packageneric/generic/bin/version) $(basename $0) script" &&
	echoing "source package: $($PACKAGENERIC__ROOT/packageneric/generic/bin/package.meta-information name) $($PACKAGENERIC__ROOT/packageneric/generic/bin/package.meta-information version) $($PACKAGENERIC__ROOT/packageneric/generic/bin/package.meta-information archive)" &&
	echoing '===========================================================' &&
	echoing '' &&

	echo $version | sed 's/^\([0-9]*\)\..*/\1/'         > version--major &&
	echo $version | sed 's/^[0-9]*\.\([0-9]*\)\..*/\1/' > version--minor &&
	echo $version | sed 's/.*\.\([0-9]*\)$/\1/'         > version--patch &&

	local output=$PACKAGENERIC__OUTPUT/autotools/autoconf/$PACKAGENERIC__SUBPATH &&
	mkdir --parents $output &&
	local output__m4=$output/m4_define.ac &&
	local output__ac=$output/PACKAGENERIC__DEFINE_AND_SUBST.ac &&
	{
		cat > $output__m4 <<-eof
			#! /usr/bin/m4
			# This file was autogenerated by $PACKAGENERIC__SUBPATH ; do not edit.
		eof
	} &&
	{
		cat > $output__ac <<-eof
			#! /usr/bin/autoconf
			# This file was autogenerated by $PACKAGENERIC__SUBPATH ; do not edit.
		eof
	} &&
	for meta in *
	do
		local symbol=$(basename $meta | tr '[:lower:]-' '[:upper:]_') &&
		echo "m4_define([PACKAGENERIC__DETAIL__M4__PACKAGE__$symbol], [$(cat $meta)])" >> $output__m4 &&
		echo "PACKAGENERIC__DEFINE_AND_SUBST(PACKAGENERIC__PACKAGE__$symbol, [PACKAGENERIC__DETAIL__M4__PACKAGE__$symbol], [packageneric/$PACKAGENERIC__OUTPUT__SUBPATH/$(basename $meta)])" >> $output__ac ||
		return
	done
} &&

main "$@"
