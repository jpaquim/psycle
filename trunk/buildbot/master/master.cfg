c = BuildmasterConfig = {}

c['projectName'] = 'psycle'
c['projectURL'] = 'http://psycle.sourceforge.net'
c['buildbotURL'] = 'http://anechoid.retropaganda.info:8010/'

from buildbot.changes.pb import PBChangeSource
c['sources'] = [PBChangeSource()]

psycle_svn = 'https://svn.sourceforge.net/svnroot/psycle/trunk'

c['bots'] = [
	('bohan0', 'password'),
	('bohan1', 'password'),
	('bohan2', 'password')
]

slaves = ['bohan0', 'bohan1', 'bohan2']

from buildbot import locks
from buildbot.process import factory, step
from buildbot.scheduler import Scheduler, AnyBranchScheduler, Dependent

cpu_lock = locks.SlaveLock('cpu')

c['builders'] = []
c['schedulers'] = []

bunch_timer=6*60

def filter(change, prefixes):
	for file in change.files:
		for prefix in prefixes:
			if file.startswith(prefix):
				return True
	return False

c['builders'].append(
	{
		'name': 'freepsycle',
		'slavenames': slaves,
		'builddir': 'freepsycle',
		'factory': factory.BuildFactory(
			[
				factory.s(step.SVN, mode = 'update', svnurl = psycle_svn),
				factory.s(step.Compile, command = 'scons --directory=freepsycle')
			]
		)
	}
)
c['schedulers'].append(
	Scheduler(
		name = 'freepsycle',
		branch = None,
		treeStableTimer = bunch_timer,
		builderNames = ['freepsycle'],
		fileIsImportant = lambda change: filter(change, ['/trunk/freepsycle/', '/trunk/universalis', '/trunk/diversalis', '/trunk/packageneric'])
	)
)

c['builders'].append(
	{
		'name': 'qpsycle',
		'slavenames': slaves,
		'builddir': 'qpsycle',
		'factory': factory.BuildFactory(
			[
				factory.s(step.SVN, mode = 'update', svnurl = psycle_svn),
				factory.s(step.Compile, command = 'cd qpsycle && qmake && make')
			]
		)
	}
)
c['schedulers'].append(
	Scheduler(
		name = 'qpsycle',
		branch = None,
		treeStableTimer = bunch_timer,
		builderNames = ['qpsycle'],
		fileIsImportant = lambda change: filter(change, ['/trunk/qpsycle/'])
	)
)

c['builders'].append(
	{
		'name': 'xpsycle.plugins',
		'slavenames': slaves,
		'builddir': 'xpsycle.plugins',
		'factory': factory.BuildFactory(
			[
				factory.s(step.SVN, mode = 'update', svnurl = psycle_svn),
				factory.s(step.Compile, command = 'scons --directory=xpsycle.plugins')
			]
		)
	}
)
c['schedulers'].append(
	Scheduler(
		name = 'xpsycle.plugins',
		branch = None,
		treeStableTimer = bunch_timer,
		builderNames = ['xpsycle.plugins'],
		fileIsImportant = lambda change: filter(change, ['/trunk/xpsycle.plugins/'])
	)
)

c['slavePortnum'] = 9989

c['status'] = []

from buildbot.status import html
c['status'].append(html.Waterfall(http_port = 8010))

from buildbot.status import words
c['status'].append(words.IRC(host = 'irc.efnet.net', nick = 'buildborg', channels = ['#psycle']))
c['status'].append(words.IRC(host = 'irc.freenode.net', nick = 'psycle-buildborg', channels = ['#mjoo']))

c['debugPassword'] = 'debugpassword'
